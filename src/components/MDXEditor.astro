---
interface Props {
  initialContent?: string;
  fileName?: string;
}

const { initialContent = '', fileName = 'new-article' } = Astro.props;

// é–‹ç™ºç’°å¢ƒã§ã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
if (import.meta.env.PROD) {
  return new Response(null, { status: 404 });
}
---

<div class="mdx-editor max-w-7xl mx-auto p-4">
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 h-screen max-h-[90vh]">
    <!-- Editor Panel -->
    <div class="xl:col-span-2 flex flex-col">
      <div class="mb-4">
        <h2 class="text-xl font-bold mb-2">MDX Editor</h2>

        <!-- File Management -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="file-name"
              >ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆã‚¹ãƒ©ãƒƒã‚°ï¼‰</label
            >
            <input
              aria-label="è¨˜äº‹ã®ãƒ•ã‚¡ã‚¤ãƒ«å"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
              id="file-name"
              type="text"
              value={fileName}
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="publish-date">å…¬é–‹æ—¥</label>
            <input
              aria-label="è¨˜äº‹ã®å…¬é–‹æ—¥"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
              id="publish-date"
              type="date"
            />
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
          <button
            class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
            id="save-mdx-btn"
          >
            ğŸ“„ MDXä¿å­˜
          </button>
          <button
            class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
            id="load-btn"
          >
            ğŸ“‚ èª­è¾¼
          </button>
          <button
            class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-sm"
            id="new-btn"
          >
            âœ¨ æ–°è¦
          </button>
          <button
            class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
            id="download-btn"
          >
            ğŸ’¾ DL
          </button>
        </div>

        <!-- Image Tools -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
          <button
            class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm"
            id="add-image-btn"
          >
            ğŸ–¼ï¸ ç”»åƒè¿½åŠ 
          </button>
          <button
            class="px-3 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition-colors text-sm"
            id="add-captioned-btn"
          >
            ğŸ“ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ä»˜
          </button>
          <button
            class="px-3 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition-colors text-sm"
            id="add-grid-btn"
          >
            ğŸ”² ã‚°ãƒªãƒƒãƒ‰
          </button>
          <button
            class="px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors text-sm"
            id="paste-image-btn"
          >
            ğŸ“‹ è²¼ä»˜
          </button>
        </div>
      </div>

      <!-- Drag & Drop Zone -->
      <div
        class="mb-4 p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center bg-gray-50 dark:bg-gray-800 transition-colors"
        id="drop-zone"
      >
        <p class="text-gray-500 dark:text-gray-400 text-sm">
          ğŸ“ ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯Ctrl+Vã§è²¼ã‚Šä»˜ã‘
        </p>
      </div>

      <textarea
        class="flex-1 p-4 font-mono text-sm border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
        id="mdx-input"
        placeholder="MDXã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¥åŠ›...">{initialContent}</textarea
      >
    </div>

    <!-- Preview Panel -->
    <div class="flex flex-col">
      <div class="mb-4">
        <h2 class="text-xl font-bold mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div class="flex gap-2 mb-2">
          <button
            class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
            id="refresh-btn"
          >
            ğŸ”„ æ›´æ–°
          </button>
        </div>
      </div>

      <div
        class="flex-1 p-4 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 overflow-auto prose dark:prose-invert max-w-none"
        id="preview-panel"
      >
        <p class="text-gray-500 italic">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- Image Upload Area -->
  <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg" id="uploaded-images">
    <h3 class="text-lg font-semibold mb-2">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒ</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" id="image-gallery">
      <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãŒã“ã“ã«è¡¨ç¤º -->
    </div>
  </div>

  <!-- Template Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" id="template-modal">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-4">æ–°è¦è¨˜äº‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="template-category">ã‚«ãƒ†ã‚´ãƒª</label>
          <select
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
            id="template-category"
          >
            <option value="å†™çœŸ">å†™çœŸ</option>
            <option value="æ—…è¡Œ">æ—…è¡Œ</option>
            <option value="ç«¶é¦¬">ç«¶é¦¬</option>
            <option value="æŠ€è¡“">æŠ€è¡“</option>
            <option value="ã‚¬ã‚¸ã‚§ãƒƒãƒˆ">ã‚¬ã‚¸ã‚§ãƒƒãƒˆ</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="template-title">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input
            aria-label="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«"
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
            id="template-title"
            placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«"
            type="text"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="template-description">è¨˜äº‹ã®èª¬æ˜</label
          >
          <textarea
            aria-label="è¨˜äº‹ã®èª¬æ˜"
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-800"
            id="template-description"
            placeholder="è¨˜äº‹ã®ç°¡å˜ãªèª¬æ˜"
            rows="2"></textarea>
        </div>

        <div class="flex justify-end gap-2">
          <button
            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            id="cancel-template"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            id="apply-template"
          >
            é©ç”¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CaptionedImage Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" id="captioned-modal">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full">
        <h3 class="text-lg font-bold mb-4">CaptionedImageä½œæˆ</h3>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="captioned-image-select">ç”»åƒé¸æŠ</label
          >
          <select
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
            id="captioned-image-select"
          >
            <option value="">ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="captioned-alt">Alt ãƒ†ã‚­ã‚¹ãƒˆ</label>
          <input
            aria-label="ç”»åƒã®Altãƒ†ã‚­ã‚¹ãƒˆ"
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
            id="captioned-alt"
            placeholder="ç”»åƒã®èª¬æ˜"
            type="text"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="captioned-caption">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
          <textarea
            aria-label="ç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³"
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-800"
            id="captioned-caption"
            placeholder="ç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
            rows="2"></textarea>
        </div>

        <div class="flex justify-end gap-2">
          <button
            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            id="cancel-captioned"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            id="apply-captioned"
          >
            æŒ¿å…¥
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ImageGrid Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" id="grid-modal">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-auto"
      >
        <h3 class="text-lg font-bold mb-4">ImageGridä½œæˆ</h3>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" for="grid-columns">ã‚°ãƒªãƒƒãƒ‰åˆ—æ•°</label>
          <select
            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800"
            id="grid-columns"
          >
            <option value="2">2åˆ—</option>
            <option value="3">3åˆ—</option>
            <option value="4">4åˆ—</option>
          </select>
        </div>

        <fieldset class="mb-4">
          <legend class="block text-sm font-medium mb-2">ç”»åƒé¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</legend>
          <div
            class="max-h-60 overflow-auto border border-gray-300 dark:border-gray-600 rounded p-2 bg-gray-50 dark:bg-gray-900"
            id="grid-image-selection"
          >
            <!-- ç”»åƒé¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
          </div>
        </fieldset>

        <div class="mb-4" id="grid-selected-images">
          <!-- é¸æŠã•ã‚ŒãŸç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å…¥åŠ› -->
        </div>

        <div class="flex justify-end gap-2">
          <button
            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            id="cancel-grid"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            id="apply-grid"
          >
            æŒ¿å…¥
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // MDXã‚¨ãƒ‡ã‚£ã‚¿ã®æ©Ÿèƒ½
  class MDXEditor {
    input: HTMLTextAreaElement;
    preview: HTMLDivElement;
    fileName: HTMLInputElement;
    publishDate: HTMLInputElement;
    dropZone: HTMLDivElement;
    imageGallery: HTMLDivElement;
    templateModal: HTMLDivElement;
    captionedModal: HTMLDivElement;
    gridModal: HTMLDivElement;
    uploadedImages: Array<{ name: string; url: string; file: File }>;

    constructor() {
      this.input = document.getElementById('mdx-input') as HTMLTextAreaElement;
      this.preview = document.getElementById('preview-panel') as HTMLDivElement;
      this.fileName = document.getElementById('file-name') as HTMLInputElement;
      this.publishDate = document.getElementById('publish-date') as HTMLInputElement;
      this.dropZone = document.getElementById('drop-zone') as HTMLDivElement;
      this.imageGallery = document.getElementById('image-gallery') as HTMLDivElement;

      // Modals
      this.templateModal = document.getElementById('template-modal') as HTMLDivElement;
      this.captionedModal = document.getElementById('captioned-modal') as HTMLDivElement;
      this.gridModal = document.getElementById('grid-modal') as HTMLDivElement;

      // ç”»åƒç®¡ç†
      this.uploadedImages = [];

      this.initEventListeners();
      this.loadFromLocalStorage();
      this.setDefaultDate();
    }

    setDefaultDate() {
      if (!this.publishDate.value) {
        const today = new Date().toISOString().split('T')[0];
        this.publishDate.value = today;
      }
    }

    initEventListeners() {
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      this.input.addEventListener('input', () => {
        this.updatePreview();
        this.saveToLocalStorage();
      });

      // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById('save-mdx-btn')
        ?.addEventListener('click', () => this.saveMDXToProject());
      document.getElementById('download-btn')?.addEventListener('click', () => this.downloadFile());
      document.getElementById('load-btn')?.addEventListener('click', () => this.loadFile());
      document.getElementById('new-btn')?.addEventListener('click', () => this.newFile());
      document.getElementById('refresh-btn')?.addEventListener('click', () => this.updatePreview());

      // ç”»åƒãƒ„ãƒ¼ãƒ«
      document
        .getElementById('add-image-btn')
        ?.addEventListener('click', () => this.addImageInput());
      document
        .getElementById('add-captioned-btn')
        ?.addEventListener('click', () => this.openCaptionedModal());
      document
        .getElementById('add-grid-btn')
        ?.addEventListener('click', () => this.openGridModal());
      document
        .getElementById('paste-image-btn')
        ?.addEventListener('click', () => this.pasteImage());

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
      document
        .getElementById('apply-template')
        ?.addEventListener('click', () => this.applyTemplate());
      document
        .getElementById('cancel-template')
        ?.addEventListener('click', () => this.closeModal('template-modal'));

      // CaptionedImage ãƒ¢ãƒ¼ãƒ€ãƒ«
      document
        .getElementById('apply-captioned')
        ?.addEventListener('click', () => this.applyCaptionedImage());
      document
        .getElementById('cancel-captioned')
        ?.addEventListener('click', () => this.closeModal('captioned-modal'));

      // ImageGrid ãƒ¢ãƒ¼ãƒ€ãƒ«
      document.getElementById('apply-grid')?.addEventListener('click', () => this.applyImageGrid());
      document
        .getElementById('cancel-grid')
        ?.addEventListener('click', () => this.closeModal('grid-modal'));

      // ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»æ—¥ä»˜å¤‰æ›´æ™‚ã®è‡ªå‹•ä¿å­˜
      this.fileName.addEventListener('change', () => this.saveToLocalStorage());
      this.publishDate.addEventListener('change', () => this.saveToLocalStorage());

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      this.initDragAndDrop();

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘
      this.initClipboardPaste();
    }

    initDragAndDrop() {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        this.dropZone.addEventListener(eventName, e => e.preventDefault());
        document.body.addEventListener(eventName, e => e.preventDefault());
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        this.dropZone.addEventListener(eventName, () => {
          this.dropZone.classList.add('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        this.dropZone.addEventListener(eventName, () => {
          this.dropZone.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900');
        });
      });

      this.dropZone.addEventListener('drop', e => {
        const files = Array.from(e.dataTransfer?.files || []);
        this.handleFiles(files as File[]);
      });
    }

    initClipboardPaste() {
      document.addEventListener('paste', e => {
        const items = Array.from(e.clipboardData?.items || []);
        const imageItems = items.filter(item => item.type.indexOf('image') === 0);

        imageItems.forEach(item => {
          const file = item.getAsFile();
          if (file) {
            this.handleFiles([file]);
          }
        });
      });
    }

    handleFiles(files: File[]) {
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          this.addImageToGallery(file);
        }
      });
    }

    addImageToGallery(file: File) {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
      const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      const timestamp = Date.now();
      const finalName = `${timestamp}_${sanitizedName}`;

      const url = URL.createObjectURL(file);

      this.uploadedImages.push({
        name: finalName,
        url: url,
        file: file,
      });

      // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤º
      const imageDiv = document.createElement('div');
      imageDiv.className = 'relative group cursor-pointer';
      imageDiv.innerHTML = `
        <img src="${url}" alt="${finalName}" class="w-full h-20 object-cover rounded border hover:shadow-md transition-shadow">
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity rounded flex items-center justify-center">
          <button class="text-white opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 rounded-full p-1 text-xs" onclick="window.mdxEditor.removeImage('${finalName}')">Ã—</button>
        </div>
        <p class="text-xs mt-1 truncate" title="${finalName}">${finalName}</p>
      `;

      imageDiv.addEventListener('click', () => {
        this.insertImageReference(finalName);
      });

      this.imageGallery.appendChild(imageDiv);
      this.updateImageSelects();
      this.saveToLocalStorage();
    }

    removeImage(imageName: string) {
      const index = this.uploadedImages.findIndex(img => img.name === imageName);
      if (index !== -1) {
        URL.revokeObjectURL(this.uploadedImages[index].url);
        this.uploadedImages.splice(index, 1);
        this.refreshImageGallery();
        this.updateImageSelects();
        this.saveToLocalStorage();
      }
    }

    refreshImageGallery() {
      this.imageGallery.innerHTML = '';
      this.uploadedImages.forEach(image => {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'relative group cursor-pointer';
        imageDiv.innerHTML = `
          <img src="${image.url}" alt="${image.name}" class="w-full h-20 object-cover rounded border hover:shadow-md transition-shadow">
          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity rounded flex items-center justify-center">
            <button class="text-white opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 rounded-full p-1 text-xs" onclick="window.mdxEditor.removeImage('${image.name}')">Ã—</button>
          </div>
          <p class="text-xs mt-1 truncate" title="${image.name}">${image.name}</p>
        `;

        imageDiv.addEventListener('click', () => {
          this.insertImageReference(image.name);
        });

        this.imageGallery.appendChild(imageDiv);
      });
    }

    updateImageSelects() {
      // CaptionedImageç”¨ã®é¸æŠè‚¢æ›´æ–°
      const captionedSelect = document.getElementById(
        'captioned-image-select'
      ) as HTMLSelectElement;
      captionedSelect.innerHTML = '<option value="">ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      // ImageGridç”¨ã®é¸æŠè‚¢æ›´æ–°
      const gridSelection = document.getElementById('grid-image-selection') as HTMLDivElement;
      gridSelection.innerHTML = '';

      this.uploadedImages.forEach(image => {
        // CaptionedImageç”¨
        const option = document.createElement('option');
        option.value = image.name;
        option.textContent = image.name;
        captionedSelect.appendChild(option);

        // ImageGridç”¨
        const checkbox = document.createElement('div');
        checkbox.className = 'flex items-center space-x-2 p-2';
        checkbox.innerHTML = `
          <input type="checkbox" id="grid-${image.name}" value="${image.name}" class="rounded">
          <img src="${image.url}" alt="${image.name}" class="w-12 h-12 object-cover rounded">
          <label for="grid-${image.name}" class="text-sm cursor-pointer flex-1">${image.name}</label>
        `;
        gridSelection.appendChild(checkbox);
      });

      // ImageGridã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      gridSelection.addEventListener('change', () => this.updateGridSelectedImages());
    }

    updateGridSelectedImages() {
      const checkboxes = document.querySelectorAll(
        '#grid-image-selection input[type="checkbox"]:checked'
      );
      const selectedDiv = document.getElementById('grid-selected-images') as HTMLDivElement;

      selectedDiv.innerHTML = '';

      if (checkboxes.length > 0) {
        selectedDiv.innerHTML =
          '<h4 class="font-semibold mb-2">é¸æŠã•ã‚ŒãŸç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼š</h4>';

        checkboxes.forEach(checkbox => {
          const imageName = (checkbox as HTMLInputElement).value;
          const image = this.uploadedImages.find(img => img.name === imageName);

          if (image) {
            const captionDiv = document.createElement('div');
            captionDiv.className = 'flex items-start space-x-2 mb-2 p-2 border rounded';
            captionDiv.innerHTML = `
              <img src="${image.url}" alt="${image.name}" class="w-16 h-16 object-cover rounded">
              <div class="flex-1">
                <p class="text-sm font-medium mb-1">${image.name}</p>
                <input type="text" placeholder="Alt text" data-image="${imageName}" data-type="alt" class="w-full p-1 mb-1 text-xs border rounded">
                <input type="text" placeholder="Caption (optional)" data-image="${imageName}" data-type="caption" class="w-full p-1 text-xs border rounded">
              </div>
            `;
            selectedDiv.appendChild(captionDiv);
          }
        });
      }
    }

    insertImageReference(imageName: string) {
      const cursorPos = this.input.selectionStart;
      const textBefore = this.input.value.substring(0, cursorPos);
      const textAfter = this.input.value.substring(cursorPos);

      const imageRef = `![Image](./images/${imageName})`;

      this.input.value = textBefore + imageRef + textAfter;
      this.input.selectionStart = this.input.selectionEnd = cursorPos + imageRef.length;

      this.updatePreview();
      this.saveToLocalStorage();
    }

    addImageInput() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = e => {
        const files = Array.from((e.target as HTMLInputElement).files || []);
        this.handleFiles(files as File[]);
      };
      input.click();
    }

    pasteImage() {
      navigator.clipboard
        .read()
        .then(items => {
          items.forEach(item => {
            const imageTypes = item.types.filter(type => type.startsWith('image/'));
            imageTypes.forEach(type => {
              item.getType(type).then(blob => {
                const file = new File([blob], `pasted-${Date.now()}.png`, { type: type });
                this.handleFiles([file]);
              });
            });
          });
        })
        .catch(() => {
          alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®ç”»åƒè²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Ctrl+Vã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        });
    }

    openCaptionedModal() {
      if (this.uploadedImages.length === 0) {
        alert('ã¾ãšç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      this.captionedModal.classList.remove('hidden');
    }

    openGridModal() {
      if (this.uploadedImages.length === 0) {
        alert('ã¾ãšç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      this.gridModal.classList.remove('hidden');
      this.updateImageSelects();
    }

    applyCaptionedImage() {
      const imageSelect = document.getElementById('captioned-image-select') as HTMLSelectElement;
      const altInput = document.getElementById('captioned-alt') as HTMLInputElement;
      const captionInput = document.getElementById('captioned-caption') as HTMLTextAreaElement;

      if (!imageSelect.value) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (!altInput.value.trim()) {
        alert('Alt ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const cursorPos = this.input.selectionStart;
      const textBefore = this.input.value.substring(0, cursorPos);
      const textAfter = this.input.value.substring(cursorPos);

      let component = `<CaptionedImage\n  src="./images/${imageSelect.value}"\n  alt="${altInput.value.trim()}"`;

      if (captionInput.value.trim()) {
        component += `\n  caption="${captionInput.value.trim()}"`;
      }

      component += '\n/>\n';

      this.input.value = textBefore + component + textAfter;
      this.updatePreview();
      this.saveToLocalStorage();

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒªã‚»ãƒƒãƒˆ
      this.closeModal('captioned-modal');
      imageSelect.value = '';
      altInput.value = '';
      captionInput.value = '';
    }

    applyImageGrid() {
      const columnsSelect = document.getElementById('grid-columns') as HTMLSelectElement;
      const selectedInputs = document.querySelectorAll('#grid-selected-images input');

      if (selectedInputs.length === 0) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const images: Array<{ src: string; alt: string; caption?: string }> = [];
      const imageNames = new Set();

      selectedInputs.forEach(input => {
        const inputEl = input as HTMLInputElement;
        const imageName = inputEl.dataset.image;
        const type = inputEl.dataset.type;

        if (imageName && type) {
          imageNames.add(imageName);
        }
      });

      imageNames.forEach(imageName => {
        const altInput = document.querySelector(
          `[data-image="${imageName}"][data-type="alt"]`
        ) as HTMLInputElement;
        const captionInput = document.querySelector(
          `[data-image="${imageName}"][data-type="caption"]`
        ) as HTMLInputElement;

        if (altInput && altInput.value.trim()) {
          const imageData: any = {
            src: `./images/${imageName}`,
            alt: altInput.value.trim(),
          };

          if (captionInput && captionInput.value.trim()) {
            imageData.caption = captionInput.value.trim();
          }

          images.push(imageData);
        }
      });

      if (images.length === 0) {
        alert('Alt ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const cursorPos = this.input.selectionStart;
      const textBefore = this.input.value.substring(0, cursorPos);
      const textAfter = this.input.value.substring(cursorPos);

      let component = `<ImageGrid\n  columns={${columnsSelect.value}}\n  images={[\n`;

      images.forEach((img, index) => {
        component += `    {\n      src: "${img.src}",\n      alt: "${img.alt}"`;
        if (img.caption) {
          component += `,\n      caption: "${img.caption}"`;
        }
        component += '\n    }' + (index < images.length - 1 ? ',' : '') + '\n';
      });

      component += '  ]}\n/>\n';

      this.input.value = textBefore + component + textAfter;
      this.updatePreview();
      this.saveToLocalStorage();

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒªã‚»ãƒƒãƒˆ
      this.closeModal('grid-modal');
      document.querySelectorAll('#grid-image-selection input[type="checkbox"]').forEach(cb => {
        (cb as HTMLInputElement).checked = false;
      });
      this.updateGridSelectedImages();
    }

    updatePreview() {
      const content = this.input.value;

      // ç°¡å˜ãªMDXâ†’HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤‰æ›
      let html = content
        // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼é™¤å»
        .replace(/^---[\s\S]*?---\n?/, '')
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆç°¡æ˜“å¯¾å¿œï¼‰
        .replace(
          /<CaptionedImage[\s\S]*?\/>/g,
          '<div class="bg-blue-100 dark:bg-blue-800 p-4 rounded border-l-4 border-blue-500"><strong>CaptionedImage</strong><br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</div>'
        )
        .replace(
          /<ImageGrid[\s\S]*?\/>/g,
          '<div class="bg-green-100 dark:bg-green-800 p-4 rounded border-l-4 border-green-500"><strong>ImageGrid</strong><br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</div>'
        )
        // è¦‹å‡ºã—
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        // ãƒªãƒ³ã‚¯
        .replace(
          /\[([^\]]+)\]\(([^\)]+)\)/g,
          '<a href="$2" class="text-blue-600 hover:underline">$1</a>'
        )
        // å¤ªå­—ãƒ»æ–œä½“
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // ç”»åƒ
        .replace(
          /!\[([^\]]*)\]\(([^)]+)\)/g,
          "<img src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='200'%3E%3Crect width='100%25' height='100%25' fill='%23ddd'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23666'%3E$1%3C/text%3E%3C/svg%3E\" alt=\"$1\" class=\"max-w-full h-auto rounded border\">"
        )
        // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
        .replace(
          /```(\w+)?\n([\s\S]*?)```/g,
          '<pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded overflow-x-auto"><code>$2</code></pre>'
        )
        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
        .replace(/`([^`]+)`/g, '<code class="bg-gray-100 dark:bg-gray-800 px-1 rounded">$1</code>')
        // æ”¹è¡Œ
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

      // æ®µè½ã§å›²ã‚€
      if (html && !html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }

      this.preview.innerHTML =
        html || '<p class="text-gray-500 italic">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
    }

    getArticleDirectory() {
      const date = this.publishDate.value;
      if (!date) return null;

      const [year, month] = date.split('-');
      return `${year}-${month}/${date}`;
    }

    async saveMDXToProject() {
      const articleDir = this.getArticleDirectory();
      const fileName = this.fileName.value;

      if (!articleDir || !fileName) {
        alert('å…¬é–‹æ—¥ã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¤ºã™ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      const zip = await this.createProjectZip(articleDir, fileName);

      // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${fileName}-${articleDir.replace('/', '-')}.zip`;
      a.click();
      URL.revokeObjectURL(url);

      alert(
        `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚\nè§£å‡å¾Œã€ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«é…ç½®ã—ã¦ãã ã•ã„ï¼š\nsrc/content/blog/${articleDir}/`
      );
    }

    async createProjectZip(articleDir: string, fileName: string) {
      // å‹•çš„ã«JSZipã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆCDNã‹ã‚‰ï¼‰
      const JSZip = await this.loadJSZip();
      const zip = new JSZip();

      // ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
      const rootFolder = zip.folder(`${fileName}-${articleDir.replace('/', '-')}`);

      // README.md ã‚’ä½œæˆ
      const readmeContent = `# ${fileName}

## é…ç½®æ–¹æ³•

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š

\`\`\`
src/content/blog/${articleDir}/
\`\`\`

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

- ${fileName}.mdx - ãƒ¡ã‚¤ãƒ³è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«
- images/ - è¨˜äº‹ã§ä½¿ç”¨ã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªãƒ‘ã‚¹ã«é…ç½®
2. ç”»åƒãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ã‚’ç¢ºèª
3. \`npm run dev\` ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ç¢ºèª
`;
      rootFolder?.file('README.md', readmeContent);

      // MDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
      rootFolder?.file(`${fileName}.mdx`, this.input.value);

      // ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
      const imageFolder = rootFolder?.folder('images');

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’è¿½åŠ 
      for (const image of this.uploadedImages) {
        imageFolder?.file(image.name, image.file);
      }

      return zip;
    }

    async loadJSZip() {
      // JSZipã‚’CDNã‹ã‚‰å‹•çš„ãƒ­ãƒ¼ãƒ‰
      if (!(window as any).JSZip) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        document.head.appendChild(script);

        await new Promise(resolve => {
          script.onload = resolve;
        });
      }

      return (window as any).JSZip;
    }

    downloadFile() {
      const content = this.input.value;
      const filename = this.fileName.value || 'article';

      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}.mdx`;
      a.click();
      URL.revokeObjectURL(url);
    }

    loadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.mdx,.md';
      input.onchange = e => {
        const file = (e.target as HTMLInputElement).files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            this.input.value = e.target?.result as string;
            this.fileName.value = file.name.replace(/\.(mdx?|md)$/, '');
            this.updatePreview();
            this.saveToLocalStorage();
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    newFile() {
      this.templateModal.classList.remove('hidden');
    }

    closeModal(modalId: string) {
      document.getElementById(modalId)?.classList.add('hidden');
    }

    applyTemplate() {
      const category = (document.getElementById('template-category') as HTMLSelectElement).value;
      const title = (document.getElementById('template-title') as HTMLInputElement).value;
      const description = (document.getElementById('template-description') as HTMLTextAreaElement)
        .value;

      const today = new Date().toISOString().split('T')[0];
      this.publishDate.value = today;

      const template = `---
title: '${title || 'æ–°ã—ã„è¨˜äº‹'}'
description: '${description || 'è¨˜äº‹ã®èª¬æ˜'}'
pubDate: '${today}'
heroImage: './images/hero-image.jpg' # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
category: '${category}'
---

# ${title || 'æ–°ã—ã„è¨˜äº‹'}

è¨˜äº‹ã®å†…å®¹ã‚’ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„ã€‚

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—

- ãƒªã‚¹ãƒˆé …ç›®1
- ãƒªã‚¹ãƒˆé …ç›®2  
- ãƒªã‚¹ãƒˆé …ç›®3

**å¤ªå­—ã®ãƒ†ã‚­ã‚¹ãƒˆ** ã¨ *æ–œä½“ã®ãƒ†ã‚­ã‚¹ãƒˆ*

\`ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰\` ã®ä¾‹

\`\`\`javascript
// ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ä¾‹
console.log('Hello, World!');
\`\`\`

[ãƒªãƒ³ã‚¯ã®ä¾‹](https://example.com)

## ç”»åƒã®ä¾‹

![ç”»åƒã®èª¬æ˜](./images/sample.jpg)

<CaptionedImage
  src="./images/sample.jpg"
  alt="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ä»˜ãç”»åƒã®èª¬æ˜"
  caption="ã“ã®ç”»åƒã«ã¯ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒä»˜ã„ã¦ã„ã¾ã™"
/>

<ImageGrid
  columns={2}
  images={[
    {
      src: "./images/image1.jpg",
      alt: "ç”»åƒ1ã®èª¬æ˜",
      caption: "ç”»åƒ1ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³"
    },
    {
      src: "./images/image2.jpg", 
      alt: "ç”»åƒ2ã®èª¬æ˜",
      caption: "ç”»åƒ2ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³"
    }
  ]}
/>
`;

      this.input.value = template;
      this.fileName.value =
        title
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-') || 'new-article';
      this.updatePreview();
      this.saveToLocalStorage();
      this.closeModal('template-modal');
    }

    saveToLocalStorage() {
      const data = {
        content: this.input.value,
        fileName: this.fileName.value,
        publishDate: this.publishDate.value,
        images: this.uploadedImages.map((img: { name: string; url: string; file: File }) => ({
          name: img.name,
          url: img.url,
          // fileã¯ä¿å­˜ã§ããªã„ã®ã§é™¤å¤–
        })),
      };

      localStorage.setItem('mdx-editor-data', JSON.stringify(data));
    }

    loadFromLocalStorage() {
      const savedData = localStorage.getItem('mdx-editor-data');

      if (savedData) {
        try {
          const data = JSON.parse(savedData);

          if (data.content) {
            this.input.value = data.content;
            this.updatePreview();
          }
          if (data.fileName) {
            this.fileName.value = data.fileName;
          }
          if (data.publishDate) {
            this.publishDate.value = data.publishDate;
          }

          // ç”»åƒã¯å¾©å…ƒã§ããªã„ã®ã§ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢
          this.uploadedImages = [];
          this.imageGallery.innerHTML =
            '<p class="text-gray-500 text-sm col-span-full">ç”»åƒã¯å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>';
        } catch (e) {
          console.error('LocalStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }
      }
    }
  }

  // ã‚¨ãƒ‡ã‚£ã‚¿åˆæœŸåŒ–
  const editor = new MDXEditor();
  (window as any).mdxEditor = editor; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
</script>
